<!DOCTYPE html>
<!--
Scott Wilber justification: Front-end must evoke strong memetic resonance while demanding minimal activation energy (canon.yaml › design_principles.zero_friction). This Win95 skin taps collective nostalgia to lower cognitive load and invite playful contribution – SW.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Shorter, mobile-friendly title (Jakob Nielsen: first 15 chars matter) -->
    <title>Chronomancy Mesh</title>
    <!-- PWA / OS integration cues -->
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="theme-color" content="#000080" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* CSS custom properties for Win95 palette (Dieter Rams: one source of truth) */
        :root{
            --win95-gray-light:#c0c0c0;
            --win95-gray-dark:#808080;
            --win95-blue-dark:#000080;
            --win95-blue-light:#0000ff;
            /* dark mode */
            --plate:#202020;
            --bevel-light:#404040;
            --bevel-dark:#000000;
            --title-dark:#001b66;
            --title-light:#0033cc;
            --accent:#00ffff;
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'MS Sans Serif',sans-serif;background:linear-gradient(135deg,#004350 0%,#002830 100%);color:#00f0f0;overflow:hidden;height:100vh;width:100vw;max-width:100%;cursor:default}
        .desktop{position:absolute;top:0;left:0;width:100%;height:100%;/* grid removed per audit */}
        #three-canvas{position:absolute;top:30px;left:0;width:100%;height:calc(100% - 70px);z-index:1;opacity:.2}
        .taskbar{position:fixed;bottom:0;left:0;width:100%;height:40px;background:linear-gradient(to bottom,var(--win95-gray-light) 0%,var(--win95-gray-dark) 100%);border-top:2px solid #fff;display:flex;align-items:center;padding:0 4px;z-index:1000;box-shadow:inset 0 1px 0 rgba(255,255,255,.8)}
        .start-button{height:32px;padding:0 12px;background:linear-gradient(to bottom,#c0c0c0 0%,#808080 100%);border:2px outset #c0c0c0;font-family:'MS Sans Serif',sans-serif;font-size:11px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:4px}
        .start-button:active{border:2px inset #c0c0c0}
        .taskbar-time{margin-left:auto;padding:0 8px;height:32px;background:linear-gradient(to bottom,#c0c0c0 0%,#808080 100%);border:1px inset #c0c0c0;display:flex;align-items:center;font-size:11px}
        .title-bar{position:fixed;top:0;left:0;width:100%;height:30px;background:linear-gradient(to right,var(--title-dark) 0%,var(--title-light) 100%);color:#fff;display:flex;align-items:center;padding:0 8px;font-size:11px;font-weight:bold;z-index:999}
        .title-text{flex:1;text-align:center;letter-spacing:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .window{position:absolute;background:var(--win95-gray-light);border:2px outset var(--win95-gray-light);min-width:300px;min-height:200px;z-index:100;display:none}
        .window.active{display:block;z-index:200}
        .window-header{height:18px;background:linear-gradient(to right,#000080 0%,#0000ff 100%);display:flex;align-items:center;padding:0 4px;color:#fff;font-size:11px;font-weight:bold;cursor:move}
        .window-title{flex:1}
        .window-controls{display:flex;gap:2px}
        .window-button{width:16px;height:14px;background:#c0c0c0;border:1px outset #c0c0c0;font-size:8px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .window-button:active{border:1px inset #c0c0c0}
        .window-content{padding:8px;background:#c0c0c0;height:calc(100% - 18px);overflow:auto}
        .welcome-card{text-align:center;padding:20px;background:#fff;border:2px inset #c0c0c0;margin:10px}
        .logo{font-size:24px;font-weight:bold;color:#000080;margin-bottom:10px}
        .tagline{font-size:12px;margin-bottom:20px;color:#000}
        .win95-button{background:linear-gradient(to bottom,#c0c0c0 0%,#808080 100%);border:2px outset #c0c0c0;padding:6px 16px;font-size:11px;cursor:pointer;margin:4px;font-family:'MS Sans Serif',sans-serif}
        .win95-button:active{border:2px inset #c0c0c0}
        .win95-button:hover{background:linear-gradient(to bottom,#d0d0d0 0%,#909090 100%)}
        .win95-button.primary{background:linear-gradient(to bottom,#000080 0%,#0000ff 100%);color:#fff;font-weight:bold}
        .progress-ring{width:120px;height:120px;margin:20px auto;position:relative}
        .progress-ring svg{width:100%;height:100%;transform:rotate(-90deg)}
        .progress-ring-bg{fill:none;stroke:#808080;stroke-width:8}
        .progress-ring-fill{fill:none;stroke:#000080;stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset .3s ease}
        .progress-ring-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;font-size:12px;font-weight:bold}
        .entropy-panel{background:#fff;border:2px inset #c0c0c0;padding:8px;margin:8px 0}
        .entropy-row{display:flex;justify-content:space-between;align-items:center;margin:4px 0;font-size:11px}
        .entropy-stars{color:#000080}
        .entropy-value{font-weight:bold;font-family:'Courier New',monospace}
        .sparkline-container{background:#fff;border:2px inset #c0c0c0;padding:8px;margin:8px 0;height:80px;cursor:pointer}
        .sparkline{width:100%;height:100%}
        .status-log{background:#fff;border:2px inset #c0c0c0;padding:8px;height:120px;overflow-y:auto;font-size:11px;font-family:'Courier New',monospace}
        .log-entry{margin:2px 0;display:flex;align-items:center}
        .log-icon{margin-right:4px;font-weight:bold}
        .log-icon.success{color:#008000}.log-icon.info{color:#000080}.log-icon.warning{color:#ff8000}.log-icon.error{color:#ff0000}
        .led{width:8px;height:8px;border-radius:50%;display:inline-block;margin:0 2px;border:1px solid #404040}
        .led.green{background:#0f0;box-shadow:0 0 4px #0f0}.led.red{background:#f00;box-shadow:0 0 4px #f00}.led.yellow{background:#ff0;box-shadow:0 0 4px #ff0}.led.blue{background:#00f;box-shadow:0 0 4px #00f}
        .toast-banner{position:fixed;top:30px;left:50%;transform:translateX(-50%);background:#ffff80;border:2px solid #000;padding:8px 16px;font-size:11px;z-index:500;display:none}
        .toast-banner.show{display:block;animation:slideDown .3s ease}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:999}
        .modal.show{display:flex}
        .modal-content{background:#c0c0c0;border:2px outset #c0c0c0;padding:16px;max-width:400px;text-align:center}
        .modal-title{font-weight:bold;margin-bottom:12px;color:#000080}
        .permission-icons{display:flex;justify-content:center;gap:20px;margin:16px 0}
        .permission-icon{text-align:center;font-size:24px}
        @keyframes slideDown{from{transform:translate(-50%,-100%)}to{transform:translate(-50%,0)}}
        @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:.3}}
        .blinking{animation:blink 1s infinite}
        @keyframes glow{0%,100%{box-shadow:0 0 5px #0f0}50%{box-shadow:0 0 20px #0f0}}
        .glowing{animation:glow .5s ease-in-out}
        .settings-group{margin:12px 0;padding:8px;background:#fff;border:1px solid #808080}
        .settings-label{font-weight:bold;font-size:11px;margin-bottom:4px}
        .slider-container{display:flex;align-items:center;gap:8px}
        .slider{flex:1;height:4px;background:#808080;border:1px inset #c0c0c0;cursor:pointer;position:relative}
        .slider-thumb{width:16px;height:16px;background:#c0c0c0;border:2px outset #c0c0c0;position:absolute;top:-6px;cursor:grab}
        .slider-thumb:active{cursor:grabbing;border:2px inset #c0c0c0}
        @media (max-width:768px){.window{width:95%!important;height:auto!important;left:2.5%!important;top:40px!important;max-height:calc(100vh - 120px);transform:none!important}}
        .big-timer {
            font-family: 'Courier New', monospace;
            font-size: 42px;
            color: #000;
            text-align: center;
            margin-top: 30px;
            letter-spacing: 2px;
        }
        .prompt-textarea {
            width: 100%;
            height: 120px;
            font-size: 11px;
            margin: 8px 0;
            resize: vertical;
        }
        .wallet-field {
            font-family:'Courier New',monospace;
            font-size:11px;
            word-break:break-all;
            background:#fff;
            border:1px solid #808080;
            padding:4px;
            margin:4px 0;
        }
        .chain-field{
            font-family:'Courier New',monospace;
            font-size:11px;
            word-break:break-all;
            background:#fff;
            border:1px solid #808080;
            padding:4px;
            margin:4px 0;
        }
        .walk-field{
            font-family:'Courier New',monospace;
            font-size:20px;
            text-align:center;
            background:#fff;
            border:2px inset #808080;
            padding:6px;
            margin:8px 0;
        }
        /* Tufte-style sidenote tooltips */
        .help-icon{display:inline-block;width:14px;height:14px;line-height:14px;background:#000080;color:#fff;font-size:11px;font-weight:bold;text-align:center;border-radius:50%;margin-left:6px;cursor:help;position:relative;user-select:none}
        .help-icon .tooltip{display:none;position:absolute;left:16px;top:-4px;z-index:2000;max-width:240px;padding:6px;background:#ffffe0;border:1px solid #808080;color:#000;font-size:10px;font-family:'MS Sans Serif',sans-serif;box-shadow:2px 2px 4px rgba(0,0,0,.3)}
        .help-icon:hover .tooltip{display:block}
        .help-icon:hover{filter:brightness(1.2)}
        .about-content{font-size:11px;line-height:1.4}
        /* helper to horizontally center fixed-width windows */
        .center-x{left:50%!important;transform:translateX(-50%)!important;}
        /* Auto-hide title bar on small screens; reveal on hover */
        @media (max-width:768px){
            .title-bar{transform:translateY(-100%);transition:transform .3s ease;}
            .title-bar:hover{transform:translateY(0);}
        }
        .control-strip{position:fixed;bottom:40px;left:0;width:100%;height:36px;background:var(--plate);border-top:2px solid var(--bevel-light);border-bottom:2px solid var(--bevel-dark);display:flex;align-items:center;gap:16px;padding:0 8px;font-size:11px;color:var(--accent);z-index:1001}
        .cs-btn{background:linear-gradient(to bottom,#2f2f2f 0%,#151515 100%);border:2px outset #555;font-size:11px;padding:2px 8px;color:var(--accent);cursor:pointer}
        .cs-btn:active{border:2px inset #555}
    </style>
</head>
<body>
    <div class="desktop"></div>
    <canvas id="three-canvas"></canvas>
    <div class="title-bar"><span class="title-text">DARPA-CHRON v1.2.1 - CHRONOMANCY MESH INTERFACE [CLASSIFIED]</span></div>
    <div class="toast-banner" id="toast">App in background. Sampling slows to ~10 kHz; pulse still counts.</div>
    <div class="modal" id="permission-modal">
        <div class="modal-content">
            <div class="modal-title">🔓 SAMPLER INITIALIZATION REQUIRED</div>
            <p style="margin-bottom: 16px; font-size: 11px;">AudioContext needs user interaction to unlock dual-timer sampling.</p>
            <div class="permission-icons"><div class="permission-icon">⏰<br><small>rAF Timer</small></div><div class="permission-icon">🔊<br><small>Audio Timer</small></div></div>
            <button class="win95-button primary" onclick="unlockSampler()">UNLOCK SAMPLER</button>
        </div>
    </div>
    <div class="window active" id="welcome-window" style="top: 60px; left: 50%; transform: translateX(-50%); width: 400px; height: 300px;">
        <div class="window-header"><span class="window-title">🌐 Chronomancy Mesh - Welcome</span><div class="window-controls"><div class="window-button">_</div><div class="window-button">□</div><div class="window-button" onclick="closeWindow('welcome-window')">×</div></div></div>
        <div class="window-content"><div class="welcome-card"><div class="logo">⚡ CHRONOMANCY</div><div class="tagline">Help power the public randomness mesh</div><p style="font-size: 11px; margin: 12px 0;">Your device contributes entropy through dual-timer variance sampling. Each pulse strengthens the distributed random beacon network.</p><button class="win95-button primary" onclick="startContributing()">UNLOCK & START</button></div></div>
    </div>
    <div class="window" id="session-window" style="top: 80px; left: 100px; width: 380px; height: 500px;">
        <div class="window-header"><span class="window-title">📊 Live Session - Epoch <span id="epoch-num">123</span></span><div class="window-controls"><div class="window-button">_</div><div class="window-button">□</div><div class="window-button" onclick="closeWindow('session-window')">×</div></div></div>
        <div class="window-content">
            <div class="progress-ring" id="progress-ring"><svg><circle class="progress-ring-bg" cx="60" cy="60" r="52"></circle><circle class="progress-ring-fill" cx="60" cy="60" r="52" stroke-dasharray="326.7" stroke-dashoffset="0" id="progress-circle"></circle></svg><div class="progress-ring-text"><div>Epoch <span id="epoch-display">123</span></div><div><span id="time-left">00:08</span> left</div></div></div>
            <div class="entropy-panel">
                <div class="entropy-row"><span>Timer variance:</span><span class="entropy-stars" id="variance-stars">★★★★☆</span></div>
                <div class="entropy-row"><span>Current cap:</span><span class="entropy-value" id="current-cap">180 kHz</span></div>
                <div class="entropy-row"><span>Bytes revealed:</span><span class="entropy-value" id="bytes-revealed">1,024</span></div>
                <div class="entropy-row"><span>Status:</span><span>ONLINE <span class="led green" id="status-led"></span></span></div>
            </div>
            <div class="sparkline-container" onclick="showDetailedLog()"><canvas class="sparkline" id="sparkline" width="300" height="60"></canvas></div>
            <div class="status-log" id="status-log"></div>
        </div>
    </div>
    <div class="window" id="settings-window" style="top: 120px; left: 150px; width: 350px; height: 400px;">
        <div class="window-header"><span class="window-title">⚙️ Configuration</span><div class="window-controls"><div class="window-button">_</div><div class="window-button">□</div><div class="window-button" onclick="closeWindow('settings-window')">×</div></div></div>
        <div class="window-content">
            <div class="settings-group"><div class="settings-label">Operator ID</div><div style="font-family:'Courier New',monospace;font-size:11px;color:#000080;">op_7f3a9b2c_001</div></div>
            <div class="settings-group"><div class="settings-label">Sampling Limit</div><div class="slider-container"><span style="font-size:10px;">50 kHz</span><div class="slider"><div class="slider-thumb" style="left: 65%;"></div></div><span style="font-size:10px;" id="max-cap">180 kHz</span></div></div>
            <div class="settings-group"><div class="settings-label">Source Selector</div><select style="width:100%;padding:2px;font-size:11px;"><option selected>js_timer (Dual RAF/Audio)</option><option disabled>pcqng_native (Coming Soon)</option></select></div>
            <div class="settings-group"><div class="settings-label">Countdown Display</div><label style="font-size:11px;"><input type="checkbox" id="show-countdown"> Show next ping countdown</label></div>
            <div class="settings-group"><div class="settings-label">Debug Options</div><label style="font-size:11px;"><input type="checkbox" id="debug-log"> Show debug log</label></div>
            <div style="text-align:center;margin-top:16px;"><button class="win95-button" onclick="exportHistory()">Export Trace History</button></div>
        </div>
    </div>
    <div class="control-strip">
        <span id="cs-window" title="Ping window">🕒 -- : -- – -- : --</span>
        <button id="cs-dec" class="cs-btn" title="Fewer pings">➖</button>
        <span id="cs-count" title="Daily ping quota">⧗ 0</span>
        <button id="cs-inc" class="cs-btn" title="More pings">➕</button>
        <button id="cs-mute" class="cs-btn" title="Mute 1 h">⏸️</button>
        <button id="cs-quantum" class="cs-btn" title="Quantum Point">⚛️</button>
    </div>
    <div class="taskbar"><div class="start-button" onclick="showStartMenu()"><span>🚀 Start</span></div><div class="taskbar-time" id="taskbar-time">12:34 PM</div></div>
    <!-- Timer Window -->
    <div class="window" id="timer-window" style="top: 320px; left: 50%; transform: translateX(-50%); width: 320px; height: 220px;">
        <div class="window-header">
            <span class="window-title">⏰ Next Temporal Ping <span class="help-icon">?<span class="tooltip">When the countdown reaches zero, pause and observe. Record any anomaly you notice. Random pings disrupt habitual time patterns – an idea championed by Edward Tufte's 'small multiples': many tiny experiments reveal hidden structure.</span></span></span>
            <div class="window-controls">
                <div class="window-button" onclick="closeWindow('timer-window')">×</div>
            </div>
        </div>
        <div class="window-content">
            <div class="big-timer" id="countdown-display">--:--:--</div>
            <p style="font-size:11px;margin-top:16px;text-align:center;">Random signal arrives, observe &amp; record anomalies.</p>
        </div>
    </div>

    <!-- Anomaly Prompt Window -->
    <div class="window center-x" id="prompt-window" style="top: 120px; width: 360px; height: 300px;">
        <div class="window-header">
            <span class="window-title">📝 Record Temporal Anomaly</span>
            <div class="window-controls">
                <div class="window-button" onclick="closeWindow('prompt-window')">×</div>
            </div>
        </div>
        <div class="window-content">
            <p style="font-size:11px;">Describe what you noticed at the exact moment of the ping:</p>
            <textarea class="prompt-textarea" id="anomaly-text"></textarea>
            <div style="text-align:center;margin-top:8px;">
                <button class="win95-button primary" onclick="submitAnomaly()">SAVE</button>
                <button class="win95-button" onclick="skipAnomaly()">SKIP</button>
            </div>
        </div>
    </div>
    <!-- Wallet Window -->
    <div class="window center-x" id="wallet-window" style="top:140px;width:340px;height:260px;">
        <div class="window-header">
            <span class="window-title">💰 CHR Testnet Wallet <span class="help-icon">?<span class="tooltip">Your pseudo-address on the CHR testnet. It refreshes locally – no KYC required. Balance is for demo purposes and will reset.</span></span></span>
            <div class="window-controls"><div class="window-button" onclick="closeWindow('wallet-window')">×</div></div>
        </div>
        <div class="window-content">
            <div style="font-size:11px;" id="wallet-greet">Hi, operator!</div>
            <div style="font-size:11px;margin-top:6px;">Address:</div>
            <div class="wallet-field" id="wallet-address">loading...</div><span class="help-icon">?<span class="tooltip">Your pseudo-address on the CHR testnet. No KYC; balance resets if you clear storage.</span></span>
            <div style="font-size:11px;">Balance:</div>
            <div class="wallet-field" id="wallet-balance">-- CHR</div>
            <div style="font-size:11px;margin-top:8px;">Send CHR to another user:</div>
            <input id="send-to" placeholder="Recipient user_id" style="width:100%;font-size:11px;margin:2px 0;">
            <input id="send-amt" type="number" min="1" placeholder="Amount" style="width:100%;font-size:11px;margin:2px 0;">
            <button class="win95-button" style="width:100%;" onclick="sendChr()">Send</button>
        </div>
    </div>
    <!-- Blockchain Window -->
    <div class="window center-x" id="chain-window" style="top:180px;width:360px;height:260px;">
        <div class="window-header">
            <span class="window-title">⛓️ Entropy Chain <span class="help-icon">?<span class="tooltip">Each block folds shard Merkle roots together with public drand randomness. Hover values update live so you can audit entropy flow in real time.</span></span></span>
            <div class="window-controls"><div class="window-button" onclick="closeWindow('chain-window')">×</div></div>
        </div>
        <div class="window-content" id="chain-content">
            <div style="font-size:11px;">Height:</div>
            <div class="chain-field" id="chain-height">--</div>
            <div style="font-size:11px;">Drand Round:</div>
            <div class="chain-field" id="chain-drand">--</div>
            <div style="font-size:11px;">Block Hash (first 16):</div>
            <div class="chain-field" id="chain-hash">--</div>
            <div style="text-align:center;margin-top:12px;">
                <button class="win95-button" onclick="refreshChain()">Refresh</button>
            </div>
        </div>
    </div>
    <!-- About Window -->
    <div class="window center-x" id="about-window" style="top:220px;width:420px;height:300px;">
        <div class="window-header"><span class="window-title">🛈 Chronomancy – How Mining Works</span><div class="window-controls"><div class="window-button" onclick="closeWindow('about-window')">×</div></div></div>
        <div class="window-content about-content">
            <p><b>1. Sample → Entropy</b><br>Your browser measures the tiny timing jitter between two independent clocks (RAF vs. Audio). That unpredictable drift is harvested as raw entropy.</p>
            <p><b>2. Commit → Shard</b><br>Every 10 seconds the entropy is packed into a <i>Merkle root</i> and submitted to your shard mixer. Quality metrics decide how much of it is <i>honest</i>.</p>
            <p><b>3. Earn ENT</b><br>Honest bits become <span style="color:#000080;font-weight:bold;">ENT</span> tokens—credited to your wallet automatically. Better quality ⇒ more tokens.</p>
            <p><b>4. Spend</b><br>You'll soon be able to burn ENT to request premium randomness for PSI experiments, retrocausal games, or to boost global stasis-field probes.</p>
            <p style="text-align:center;margin-top:12px;"><button class="win95-button" onclick="closeWindow('about-window')">GOT IT</button></p>
        </div>
    </div>
    <!-- Leaderboard Window -->
    <div class="window center-x" id="board-window" style="top:260px;width:320px;height:260px;">
        <div class="window-header"><span class="window-title">🏆 Top Miners</span><div class="window-controls"><div class="window-button" onclick="closeWindow('board-window')">×</div></div></div>
        <div class="window-content"><table style="width:100%;font-size:11px;" id="board-table"><thead><tr><th>#</th><th>User</th><th>CHR</th></tr></thead><tbody></tbody></table></div>
    </div>
    <!-- Bets Window -->
    <div class="window center-x" id="bet-window" style="top:300px;width:340px;height:260px;">
        <div class="window-header"><span class="window-title">🎲 Random Walk Bets</span><div class="window-controls"><div class="window-button" onclick="closeWindow('bet-window')">×</div></div></div>
        <div class="window-content" id="bet-content">
            <div style="font-size:11px;">Current Walk Value (Σ steps):</div>
            <div class="walk-field" id="walk-value">--</div>
            <div style="font-size:11px;">Predict next move:</div>
            <input id="bet-stake" type="number" min="1" value="100" style="width:60px;font-size:11px;"> <span style="font-size:11px;">CHR&nbsp;stake</span><br>
            <button class="win95-button" onclick="placeBet('up')" style="margin-top:6px;">⬆️ UP</button>
            <button class="win95-button" onclick="placeBet('down')">⬇️ DOWN</button>
            <div id="bet-status" style="font-size:10px;color:#000080;margin-top:8px;"></div>
        </div>
    </div>
    <!-- Quick-Start Alarm Wizard (hidden after first run) -->
    <div id="wizard" style="position:fixed;inset:0;background:rgba(0,32,32,.92);display:none;z-index:2000;font-family:'MS Sans Serif',sans-serif;">
        <div id="wizard-box" class="window active center-x" style="top:80px;width:360px;min-height:220px;">
            <div class="window-header"><span class="window-title" id="wizard-title">🕒 Alarm Setup</span></div>
            <div class="window-content" id="wizard-step" style="text-align:center;font-size:11px;">
                <!-- content injected by JS -->
            </div>
        </div>
    </div>
<script>
let audioContext=null,isUnlocked=false,currentEpoch=123,epochTimeLeft=8,currentCap=180,bytesRevealed=1024,compressionHistory=[],rafTimer=0,audioTimer=0,scene,camera,renderer,particles;
let nextPingTs=null;
function initThree(){scene=new THREE.Scene();camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);renderer=new THREE.WebGLRenderer({canvas:document.getElementById('three-canvas'),alpha:true});renderer.setSize(window.innerWidth,window.innerHeight-70);const g=new THREE.BufferGeometry(),v=[];for(let i=0;i<1000;i++){v.push((Math.random()-.5)*2000);v.push((Math.random()-.5)*2000);v.push((Math.random()-.5)*2000);}g.setAttribute('position',new THREE.Float32BufferAttribute(v,3));const m=new THREE.PointsMaterial({color:0x00ffff,size:1,opacity:.6,transparent:true});particles=new THREE.Points(g,m);scene.add(particles);camera.position.z=1000;function anim(){requestAnimationFrame(anim);particles.rotation.x+=.001;particles.rotation.y+=.002;renderer.render(scene,camera);}anim();}
function unlockSampler(){audioContext=new (window.AudioContext||window.webkitAudioContext)();audioContext.resume().then(()=>{isUnlocked=true;document.getElementById('permission-modal').classList.remove('show');startSampling();showConfetti();setTimeout(()=>{closeWindow('welcome-window');openWindow('session-window');},1500);});}
function startSampling(){function rafSample(){rafTimer=performance.now();requestAnimationFrame(rafSample);}if(audioContext){const p=audioContext.createScriptProcessor(256,1,1);p.onaudioprocess=()=>{audioTimer=audioContext.currentTime*1000};p.connect(audioContext.destination);}rafSample();setInterval(updateEpoch,1000);setInterval(simulateCommitReveal,10000);}
function updateEpoch(){epochTimeLeft--;if(epochTimeLeft<=0){epochTimeLeft=10;currentEpoch++;document.getElementById('epoch-num').textContent=currentEpoch;document.getElementById('epoch-display').textContent=currentEpoch;const r=Math.random()*.6+.2;compressionHistory.push(r);if(compressionHistory.length>20)compressionHistory.shift();updateVarianceStars(r);updateSparkline();document.getElementById('progress-ring').classList.add('glowing');setTimeout(()=>{document.getElementById('progress-ring').classList.remove('glowing');},500);}document.getElementById('time-left').textContent=`00:${epochTimeLeft.toString().padStart(2,'0')}`;const prog=(10-epochTimeLeft)/10,circ=2*Math.PI*52,off=circ*(1-prog);document.getElementById('progress-circle').style.strokeDashoffset=off;}
function simulateCommitReveal(){const ratio=Math.random()*.8+.1;if(ratio>=.80){addLogEntry('error','Quality gate failed - compression too high');showErrorModal('Trace too uniform – maybe in battery-saver? We\'ll try again next epoch.');document.getElementById('status-led').className='led red blinking';}else{addLogEntry('success','Commit sent - CID: bafk...'+Math.random().toString(36).substr(2,4));addLogEntry('success','Trace pinned to IPFS');addLogEntry('success','Reveal accepted by shard');const newCap=Math.floor(Math.random()*100)+150;currentCap=newCap;document.getElementById('current-cap').textContent=newCap+' kHz';document.getElementById('max-cap').textContent=newCap+' kHz';addLogEntry('info',`Cap updated to ${newCap} kHz`);bytesRevealed+=Math.floor(Math.random()*500)+200;document.getElementById('bytes-revealed').textContent=bytesRevealed.toLocaleString();document.getElementById('status-led').className='led green';}}
function updateVarianceStars(r){const s=Math.ceil((1-r)*5);let t='';for(let i=0;i<5;i++)t+=i<s?'★':'☆';document.getElementById('variance-stars').textContent=t;}
function updateSparkline(){const c=document.getElementById('sparkline'),x=c.getContext('2d'),w=c.width,h=c.height;x.clearRect(0,0,w,h);x.strokeStyle='#000080';x.lineWidth=2;if(compressionHistory.length>1){x.beginPath();for(let i=0;i<compressionHistory.length;i++){const px=(i/(compressionHistory.length-1))*w,py=h-compressionHistory[i]*h;if(i===0)x.moveTo(px,py);else x.lineTo(px,py);}x.stroke();}}
function addLogEntry(type,msg){const log=document.getElementById('status-log'),e=document.createElement('div');e.className='log-entry';const ic=document.createElement('span');ic.className=`log-icon ${type}`;ic.textContent=type==='success'?'[✓]':type==='info'?'[⇧]':type==='warning'?'[!]':'[✗]';const txt=document.createElement('span');txt.textContent=msg;e.appendChild(ic);e.appendChild(txt);log.appendChild(e);log.scrollTop=log.scrollHeight;while(log.children.length>10)log.removeChild(log.firstChild);}
function showConfetti(){const d=document.createElement('div');d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:48px;z-index:9999;animation:confettiPulse 1.5s ease-out;pointer-events:none;';d.textContent='🎉';document.body.appendChild(d);setTimeout(()=>document.body.removeChild(d),1500);}
function showErrorModal(m){const modal=document.createElement('div');modal.className='modal show';modal.innerHTML=`<div class="modal-content"><div class="modal-title">⚠️ ENTROPY WARNING</div><p style="margin-bottom: 16px; font-size: 11px;">${m}</p><button class="win95-button" onclick="this.parentElement.parentElement.remove()">OK</button></div>`;document.body.appendChild(modal);}
function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}
function openWindow(id){document.getElementById(id).classList.add('active');}
function closeWindow(id){document.getElementById(id).classList.remove('active');}
function startContributing(){unlockSampler();}
function showDetailedLog(){const w=document.createElement('div');w.className='window active';w.style.cssText='top: 150px; left: 200px; width: 450px; height: 300px; z-index: 300;';w.innerHTML=`<div class="window-header"><span class="window-title">📈 Detailed Compression Log</span><div class="window-controls"><div class="window-button" onclick="this.parentElement.parentElement.parentElement.remove()">×</div></div></div><div class="window-content"><table class="data-table" style="width: 100%; font-size: 10px;"><thead><tr><th>Epoch</th><th>Compression</th><th>Cap (kHz)</th><th>Status</th></tr></thead><tbody>${compressionHistory.slice(-10).map((r,i)=>`<tr><td>${currentEpoch-compressionHistory.length+i+1}</td><td>${r.toFixed(3)}</td><td>${Math.floor(r*200+100)}</td><td>${r<.8?'✓ PASS':'✗ FAIL'}</td></tr>`).join('')}</tbody></table></div>`;document.body.appendChild(w);}
function exportHistory(){const csv=['Epoch,Compression_Ratio,Cap_kHz,Timestamp',...compressionHistory.map((r,i)=>`${currentEpoch-compressionHistory.length+i+1},${r.toFixed(4)},${Math.floor(r*200+100)},${new Date().toISOString()}`)].join('\n');const blob=new Blob([csv],{type:'text/csv'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download=`chronomancy_trace_${new Date().toISOString().split('T')[0]}.csv`;a.click();URL.revokeObjectURL(url);}
function showStartMenu(){const menu=document.createElement('div');menu.style.cssText='position:fixed;bottom:40px;left:4px;background:#c0c0c0;border:2px outset #c0c0c0;min-width:200px;z-index:1001;font-size:11px;';menu.innerHTML='<div style="padding: 4px 8px; cursor: pointer; border-bottom: 1px solid #808080;" onclick="openWindow(\'session-window\')">📊 Live Session</div><div style="padding: 4px 8px; cursor: pointer; border-bottom: 1px solid #808080;" onclick="openWindow(\'settings-window\')">⚙️ Settings</div><div style="padding: 4px 8px; cursor: pointer; border-bottom: 1px solid #808080;" onclick="openWallet()">💰 Wallet</div><div style="padding: 4px 8px; cursor: pointer; border-bottom: 1px solid #808080;" onclick="openChain()">⛓️ Chain</div><div style="padding: 4px 8px; cursor: pointer; border-bottom: 1px solid #808080;" onclick="openBoard()">🏆 Leaderboard</div><div style="padding: 4px 8px; cursor: pointer; border-bottom: 1px solid #808080;" onclick="openWindow(\'bet-window\');fetchWalk()">🎲 Bets</div><div style="padding: 4px 8px; cursor: pointer; border-bottom: 1px solid #808080;" onclick="openWindow(\'about-window\')">🛈 About</div><div style="padding: 4px 8px; cursor: pointer;" onclick="this.parentElement.remove()">🚪 Close Menu</div>';const existing=document.querySelector('[style*="bottom: 40px"]');if(existing)existing.remove();document.body.appendChild(menu);setTimeout(()=>{if(menu.parentElement)menu.remove();},4000);}
document.addEventListener('visibilitychange',()=>{if(document.hidden)showToast('App in background. Sampling slows to ~10 kHz; pulse still counts.');});
document.addEventListener('mousedown',e=>{if(e.target.classList.contains('slider-thumb')){const slider=e.target.parentElement,rect=slider.getBoundingClientRect();function move(ev){const x=Math.max(0,Math.min(ev.clientX-rect.left,rect.width));const pct=x/rect.width*100;e.target.style.left=pct+'%';}document.addEventListener('mousemove',move);document.addEventListener('mouseup',()=>document.removeEventListener('mousemove',move),{once:true});}});
function updateTime(){const now=new Date();const t=now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});document.getElementById('taskbar-time').textContent=t;}
const style=document.createElement('style');style.textContent='@keyframes confettiPulse{0%{transform:translate(-50%,-50%) scale(0);opacity:0;}20%{transform:translate(-50%,-50%) scale(1.2);opacity:1;}100%{transform:translate(-50%,-50%) scale(1);opacity:0;}}';document.head.appendChild(style);
document.addEventListener('DOMContentLoaded',()=>{initThree();updateTime();setInterval(updateTime,1000);for(let i=0;i<10;i++)compressionHistory.push(Math.random()*.6+.2);updateSparkline();addLogEntry('success','System initialized');addLogEntry('info','Waiting for sampler unlock...');});
window.addEventListener('resize',()=>{if(renderer){renderer.setSize(window.innerWidth,window.innerHeight-70);camera.aspect=window.innerWidth/(window.innerHeight-70);camera.updateProjectionMatrix();}});
function randMinutes(min=2,max=10){return (Math.random()*(max-min)+min)*60*1000;}
function schedulePing(){nextPingTs=Date.now()+randMinutes();updateCountdown();}
function updateCountdown(){if(!nextPingTs){schedulePing();return;}const diff=nextPingTs-Date.now();if(diff<=0){triggerPing();}else{const hrs=Math.floor(diff/3600000);const mins=Math.floor((diff%3600000)/60000);const secs=Math.floor((diff%60000)/1000);document.getElementById('countdown-display').textContent=`${hrs.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;} }
function triggerPing(){// alert user
 playBeep();
 openWindow('prompt-window');
 addLogEntry('info','🔔 Temporal ping – waiting for user observation');
 schedulePing();}
function playBeep(){try{const ctx=new (window.AudioContext||window.webkitAudioContext)();const osc=ctx.createOscillator();osc.type='square';osc.frequency.value=880;osc.connect(ctx.destination);osc.start();setTimeout(()=>{osc.stop();ctx.close();},300);}catch(e){} }
function submitAnomaly(){const txt=document.getElementById('anomaly-text').value.trim();if(txt){addLogEntry('success','Anomaly noted: '+txt.slice(0,30)+'...');}closeWindow('prompt-window');document.getElementById('anomaly-text').value='';}
function skipAnomaly(){addLogEntry('info','Ping skipped');closeWindow('prompt-window');}
// attach timer to main loop
setInterval(updateCountdown,1000);
document.addEventListener('DOMContentLoaded',()=>{schedulePing();});
function openWallet(){openWindow('wallet-window');fetchWallet();}
async function fetchWallet(){try{const uid=123;const name=telegramUser;const res=await fetch(`/api/user/${uid}/wallet?name=${encodeURIComponent(name)}`);const data=await res.json();document.getElementById('wallet-greet').textContent=`Hi, ${data.name||name}!`;document.getElementById('wallet-address').textContent=data.address;document.getElementById('wallet-balance').textContent=data.balance+' CHR';}catch(e){addLogEntry('error','Wallet fetch failed');}}
async function requestFaucet(){try{const uid=123;const res=await fetch(`/api/user/${uid}/faucet`,{method:'POST'});const data=await res.json();document.getElementById('wallet-balance').textContent=data.balance+' CHR';addLogEntry('success','Faucet +1000 CHR');refreshBoard();}catch(e){addLogEntry('error','Faucet failed');}}
function openChain(){openWindow('chain-window');refreshChain();}
async function refreshChain(){try{const res=await fetch('/api/chain/latest');const blk=await res.json();document.getElementById('chain-height').textContent=blk.height;document.getElementById('chain-drand').textContent=blk.drand_round;document.getElementById('chain-hash').textContent=(blk.hash||'').slice(0,16)+'…';}catch(e){addLogEntry('error','Chain fetch failed');}}
async function sendChr(){const uid=123;const to=document.getElementById('send-to').value.trim();const amt=parseInt(document.getElementById('send-amt').value,10);if(!to||!amt)return;try{const res=await fetch('/api/transfer',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({from_id:uid,to_id:parseInt(to,10),amount:amt})});if(!res.ok){throw new Error(await res.text());}const js=await res.json();document.getElementById('wallet-balance').textContent=js.from.balance+' CHR';addLogEntry('success',`Sent ${amt} CHR to ${to}`);refreshBoard();}catch(e){addLogEntry('error','Transfer failed');}}
function openBoard(){openWindow('board-window');refreshBoard();}
async function refreshBoard(){try{const res=await fetch('/api/leaderboard');const rows=await res.json();const tbody=document.querySelector('#board-table tbody');tbody.innerHTML=rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.balance}</td></tr>`).join('');}catch(e){console.error(e);}}
// Telegram name helper
const telegramUser=(window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name)||'Operator';
async function fetchWalk(){try{const res=await fetch('/api/walk');const data=await res.json();document.getElementById('walk-value').textContent=data.value;}
catch(e){addLogEntry('error','Walk fetch failed');}}
async function placeBet(dir){const stake=parseInt(document.getElementById('bet-stake').value,10)||0;if(stake<=0)return;const uid=123;try{const res=await fetch('/api/bet',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:uid,direction:dir,stake:stake})});if(!res.ok){throw new Error(await res.text());}const js=await res.json();document.getElementById('wallet-balance').textContent=js.wallet.balance+' CHR';document.getElementById('bet-status').textContent=`Bet placed on block #${js.bet.height} (${dir.toUpperCase()})`;addLogEntry('info',`Bet ${stake} CHR ${dir.toUpperCase()} @${js.bet.height}`);refreshBoard();fetchWalk();}
catch(e){addLogEntry('error','Bet failed');}}
// poll walk every 10s when bet window open
setInterval(()=>{if(document.getElementById('bet-window').classList.contains('active'))fetchWalk();},10000);
// Countdown preference persistence
function initCountdownPreference(){
  const pref=localStorage.getItem('showCountdown')==='1';
  const cb=document.getElementById('show-countdown');
  if(cb){cb.checked=pref;cb.addEventListener('change',()=>{
    localStorage.setItem('showCountdown',cb.checked?'1':'0');
    if(cb.checked){openWindow('timer-window');}else{closeWindow('timer-window');}
  });}
  if(pref){openWindow('timer-window');}
}
document.addEventListener('DOMContentLoaded',initCountdownPreference);
// -----------------------------
// Quick-Start Wizard
// -----------------------------
function launchWizard(){
   if(localStorage.getItem('wizardDone'))return;
   const wiz=document.getElementById('wizard');
   const stepBox=document.getElementById('wizard-step');
   let step=0;
   let tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
   let winStart='09:00',winEnd='22:00';
   let pingCount=4;
   function render(){
       if(step===0){
           stepBox.innerHTML=`<p style='margin-bottom:8px;'>Hi <b>${telegramUser}</b>!</p><p style='margin:8px 0;'>Your system clock says <b>${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</b> in <b>${tz}</b>.</p><p style='margin:12px 0;'>Is that correct?</p><button class='win95-button primary' style='margin:4px;' onclick='nextStep()'>Yes</button><button class='win95-button' style='margin:4px;' onclick='changeTZ()'>Change…</button>`;
       }else if(step===1){
           stepBox.innerHTML=`<h3 style='margin-bottom:12px;'>Ping window</h3><p style='margin:8px;'>Alarms may ring between:</p><input type='time' id='wStart' value='${winStart}' style='font-size:11px;'> &nbsp;–&nbsp; <input type='time' id='wEnd' value='${winEnd}' style='font-size:11px;'><p style='margin-top:16px;'><button class='win95-button primary' onclick='saveWindow()'>Next</button></p>`;
       }else if(step===2){
           stepBox.innerHTML=`<h3 style='margin-bottom:12px;'>Daily surprises</h3><p style='margin:8px;'>How many pings per day?</p><input type='range' id='pingRange' min='1' max='9' value='${pingCount}' onchange="document.getElementById('pingVal').textContent=this.value"><span id='pingVal' style='margin-left:8px;'>${pingCount}</span><p style='margin-top:16px;'><button class='win95-button primary' onclick='finalizeWizard()'>Start Experiment</button></p>`;
       }
   }
   window.nextStep=()=>{step++;render();};
   window.changeTZ=()=>{const newtz=prompt('Enter your time-zone (IANA)',tz||'');if(newtz){tz=newtz;}render();};
   window.saveWindow=()=>{winStart=document.getElementById('wStart').value;winEnd=document.getElementById('wEnd').value;nextStep();};
   window.finalizeWizard=async()=>{
       pingCount=parseInt(document.getElementById('pingRange').value,10);
       try{
           const uid=123;
           await fetch(`/api/user/${uid}/window`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({window_start:winStart,window_end:winEnd,daily_count:pingCount})});
           await fetch(`/api/user/${uid}/settings`,{
             method:'POST',
             headers:{'Content-Type':'application/json'},
             body:JSON.stringify({user_id:uid,timezone:tz,ping_start:winStart,ping_end:winEnd})
           });
           // notify bot
           await fetch(`/api/user/${uid}/future-messages`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:'Welcome to Chronomancy! I will send you random alarms starting today.'})});
           // immediate test ping
           await fetch(`/api/user/${uid}/test-ping`,{method:'POST'});
       }catch(e){}
       localStorage.setItem('wizardDone','1');
       wiz.style.display='none';
       showToast('Wizard complete! First ping scheduled.');
       schedulePing();
   };
   wiz.style.display='block';
   render();
}
document.addEventListener('DOMContentLoaded',launchWizard);
function loadWindowSettings(){fetch(`/api/user/123/window`).then(r=>r.json()).then(js=>{if(js.window_start){document.getElementById('cs-window').textContent=`🕒 ${js.window_start} – ${js.window_end}`;document.getElementById('cs-count').textContent=`⧗ ${js.daily_count}`;}}).catch(()=>{});}

async function changePing(delta){try{const res=await fetch(`/api/user/123/window`);const js=await res.json();let newCnt=(js.daily_count||4)+delta;if(newCnt<1)newCnt=1;if(newCnt>9)newCnt=9;await fetch(`/api/user/123/window`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...js,daily_count:newCnt})});document.getElementById('cs-count').textContent=`⧗ ${newCnt}`;showToast(`Daily pings: ${newCnt}`);}catch(e){showToast('Ping update failed');}}

const incPing=()=>changePing(1);
const decPing=()=>changePing(-1);

function initControlStrip(){loadWindowSettings();document.getElementById('cs-window').onclick=openWizardWindow;document.getElementById('cs-inc').onclick=incPing;document.getElementById('cs-dec').onclick=decPing;document.getElementById('cs-mute').onclick=muteOneHour;document.getElementById('cs-quantum').onclick=requestQuantum;}
document.addEventListener('DOMContentLoaded',initControlStrip);

function openWizardWindow(){localStorage.removeItem('wizardDone');launchWizard();}
</script>
</body>
</html>
